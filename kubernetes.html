<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-Downtime Blue-Green Case Study</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-bg {
            background-color: #ffffff;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .component {
            border: 2px solid;
            border-radius: 1rem;
            padding: 1rem;
            margin: 0.5rem 0;
            text-align: center;
            min-width: 280px;
            transition: all 0.5s ease-in-out;
        }
        .traffic-arrow {
            position: absolute;
            height: 100%;
            width: 100%;
            pointer-events: none;
            top: 0;
            left: 0;
        }
        .status-box {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        /* Custom SVG path transition classes */
        .path-active { opacity: 1; transition: opacity 0.7s ease-in; }
        .path-inactive { opacity: 0; transition: opacity 0.7s ease-out; }
        .dashed-path { stroke-dasharray: 8 8; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto container-bg rounded-2xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Kubernetes Blue-Green Deployment Workflow</h1>
        <p class="text-lg text-gray-600 mb-4">Case Study: Zero-Downtime Deployment for Microservices</p>
        <p id="current-stage-title" class="text-xl font-semibold text-indigo-600 mb-6 transition-colors duration-500"></p>

        <!-- Main Visualization Container -->
        <div class="relative flex flex-col items-center justify-center p-4 border-4 border-dashed border-gray-300 bg-gray-50 rounded-xl mb-8">
            <p class="absolute top-2 left-4 text-xs font-mono text-gray-500">ON-PREMISE INFRASTRUCTURE</p>
            
            <div class="space-y-4 w-full flex flex-col items-center">
                <!-- 1. User Traffic -->
                <div class="component bg-gray-200 border-gray-400 w-3/4 max-w-sm">
                    <p class="text-lg font-bold text-gray-700">User Traffic</p>
                </div>

                <!-- 2. On-Prem Load Balancer (The VIP) -->
                <div class="component bg-indigo-500 border-indigo-700 text-white w-3/4 max-w-sm">
                    <p class="text-lg font-bold">On-Prem Load Balancer (VIP)</p>
                    <p class="text-sm font-light">The Stable Front Door (app.company.local)</p>
                </div>

                <!-- 3. NGINX Ingress Controller -->
                <div class="component bg-purple-500 border-purple-700 text-white w-3/4 max-w-sm">
                    <p class="text-lg font-bold">NGINX Ingress Controller</p>
                    <p class="text-sm font-light">The Atomic Flip Control Point</p>
                </div>
            </div>


            <!-- 4. Service Environments (Blue and Green) -->
            <div class="w-full flex justify-center space-x-4 md:space-x-8 mt-8">

                <!-- Blue Services (v1.0) -->
                <div id="blue-services" class="component w-5/12 bg-blue-100 border-blue-400">
                    <div class="text-blue-700 mb-2 status-box bg-blue-200">BLUE Environment (v1.0)</div>
                    <div class="text-xs text-gray-600">Old Billing Plugin Code</div>
                    <div id="blue-status" class="mt-2 text-xs"></div>
                </div>

                <!-- Green Services (v1.1) -->
                <div id="green-services" class="component w-5/12 bg-green-100 border-green-400">
                    <div class="text-green-700 mb-2 status-box bg-green-200">GREEN Environment (v1.1)</div>
                    <div class="text-xs text-gray-600">New Billing Plugin Code</div>
                    <div id="green-status" class="mt-2 text-xs"></div>
                </div>
            </div>


            <!-- SVG Arrows for Traffic Flow -->
            <svg id="traffic-flow-svg" class="traffic-arrow" viewBox="0 0 450 450" xmlns="http://www.w3.org/2000/svg">
                <!-- Define Markers (Arrowheads) -->
                <defs>
                    <marker id="normal-arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#374151" /></marker>
                    <marker id="ingress-arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6D28D9" /></marker>
                    <marker id="blue-arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#2563EB" /></marker>
                    <marker id="green-arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#059669" /></marker>
                    <marker id="qa-arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#FBBF24" /></marker>
                </defs>

                <!-- 1. User -> VIP (Gray) -->
                <line x1="225" y1="50" x2="225" y2="120" stroke="#4B5563" stroke-width="4" marker-end="url(#normal-arrowhead)"/>
                <!-- 2. VIP -> Ingress (Purple) -->
                <line x1="225" y1="150" x2="225" y2="220" stroke="#6D28D9" stroke-width="4" marker-end="url(#ingress-arrowhead)"/>

                <!-- 3. Ingress -> Blue Path (Main Traffic) -->
                <path id="blue-path" d="M 225 250 L 140 350" fill="none" stroke="#2563EB" stroke-width="6" marker-end="url(#blue-arrowhead)" class="path-active"/>

                <!-- 4. Ingress -> Green Path (Main Traffic) -->
                <path id="green-path" d="M 225 250 L 310 350" fill="none" stroke="#059669" stroke-width="6" marker-end="url(#green-arrowhead)" class="path-inactive"/>

                <!-- 5. QA/Internal Testing Path (Dashed Yellow) -->
                <!-- The path simulates internal traffic bypassing the main VIP/Ingress for testing purposes or using a specific test path -->
                <path id="qa-path" d="M 360 50 L 330 150 C 320 200, 310 250, 310 350" fill="none" stroke="#FBBF24" stroke-width="4" marker-end="url(#qa-arrowhead)" class="dashed-path path-inactive"/>
                <text id="qa-label" x="250" y="55" fill="#B45309" font-size="14" font-weight="bold" class="path-inactive">Internal QA Traffic (billing-test.local)</text>
            </svg>

        </div>

        <!-- Stage Description and Controls -->
        <div class="p-4 bg-gray-100 rounded-lg mb-6 border-l-4 border-gray-400">
            <p id="stage-description" class="text-gray-700 transition-opacity duration-500"></p>
        </div>

        <div class="flex justify-between items-center">
            <button id="reset-button" onclick="goToStage(0)" class="px-4 py-2 bg-gray-500 text-white rounded-lg shadow hover:bg-gray-600 transition duration-300 disabled:opacity-50" disabled>
                Restart Workflow (Step 1)
            </button>
            <button id="next-button" onclick="nextStage()" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                Next Step (1/3)
            </button>
        </div>

    </div>

    <script>
        // State variables
        let currentStage = 0;
        const totalStages = 3;

        // DOM elements
        const nextButton = document.getElementById('next-button');
        const resetButton = document.getElementById('reset-button');
        const stageTitle = document.getElementById('current-stage-title');
        const stageDescription = document.getElementById('stage-description');
        
        const blueServices = document.getElementById('blue-services');
        const greenServices = document.getElementById('green-services');
        const bluePath = document.getElementById('blue-path');
        const greenPath = document.getElementById('green-path');
        const qaPath = document.getElementById('qa-path');
        const qaLabel = document.getElementById('qa-label');

        const blueStatus = document.getElementById('blue-status');
        const greenStatus = document.getElementById('green-status');

        // Helper function to update element classes for visibility/styling
        function updatePathVisibility(element, isActive) {
            element.classList.remove(isActive ? 'path-inactive' : 'path-active');
            element.classList.add(isActive ? 'path-active' : 'path-inactive');
        }

        function updateElementStyle(element, className, text, bgColor, textColor) {
            element.className = `${className} ${textColor} ${bgColor}`;
            element.textContent = text;
        }

        // Stage definitions based on the case study flow
        const stages = [
            {
                title: "Step 1: BLUE (v1.0) is Live & Stable",
                description: "The Ingress controller routes all live traffic to the existing, stable **BLUE (v1.0)** services. The new GREEN environment is currently inactive and powered down, ensuring maximum resource efficiency.",
                blueScale: 1.0, greenScale: 0.9, bluePathActive: true, greenPathActive: false, qaPathActive: false,
                blueStatusText: "LIVE PRODUCTION (v1.0)", blueStatusBg: "bg-green-100", blueStatusColor: "text-green-700",
                greenStatusText: "INACTIVE / POWERED DOWN", greenStatusBg: "bg-red-100", greenStatusColor: "text-red-700",
            },
            {
                title: "Step 2: Deploy GREEN (v1.1) and Internal Testing",
                description: "The new version **(v1.1)** is deployed to the **GREEN** environment in parallel, receiving no live user traffic. The Ingress is temporarily configured with a secret hostname to route QA/Automated tests (dashed line) to validate the new code in isolation.",
                blueScale: 1.0, greenScale: 1.0, bluePathActive: true, greenPathActive: false, qaPathActive: true,
                blueStatusText: "LIVE PRODUCTION (v1.0)", blueStatusBg: "bg-green-100", blueStatusColor: "text-green-700",
                greenStatusText: "TESTING & VALIDATING", greenStatusBg: "bg-yellow-100", greenStatusColor: "text-yellow-700",
            },
            {
                title: "Step 3: The Atomic Flip & Instant Rollback Safety",
                description: "The Ingress rule is atomically updated. 100% of user traffic is instantly cutover to the validated **GREEN (v1.1)** services. The old BLUE environment is preserved, ready for an **instant rollback** (in under one second) by simply flipping the Ingress rule back.",
                blueScale: 0.95, greenScale: 1.0, bluePathActive: false, greenPathActive: true, qaPathActive: false,
                blueStatusText: "INSTANT ROLLBACK READY (v1.0)", blueStatusBg: "bg-gray-100", blueStatusColor: "text-gray-700",
                greenStatusText: "NEW LIVE PRODUCTION (v1.1)", greenStatusBg: "bg-green-100", greenStatusColor: "text-green-700",
            }
        ];

        function applyStage(stage) {
            stageTitle.textContent = stage.title;
            stageDescription.textContent = stage.description;

            // Apply Environment styles and scaling
            blueServices.style.transform = `scale(${stage.blueScale})`;
            greenServices.style.transform = `scale(${stage.greenScale})`;

            // Update traffic paths
            updatePathVisibility(bluePath, stage.bluePathActive);
            updatePathVisibility(greenPath, stage.greenPathActive);
            updatePathVisibility(qaPath, stage.qaPathActive);
            updatePathVisibility(qaLabel, stage.qaPathActive);

            // Update Status Boxes
            updateElementStyle(blueStatus, 'mt-2 text-xs status-box', stage.blueStatusText, stage.blueStatusBg, stage.blueStatusColor);
            updateElementStyle(greenStatus, 'mt-2 text-xs status-box', stage.greenStatusText, stage.greenStatusBg, stage.greenStatusColor);


            // Update button text and status
            nextButton.textContent = currentStage < totalStages - 1 ? `Next Step (${currentStage + 2}/${totalStages})` : `Finished! (Go to Step 1)`;
            resetButton.disabled = currentStage === 0;
        }

        function goToStage(stageIndex) {
            currentStage = stageIndex;
            applyStage(stages[currentStage]);
        }

        function nextStage() {
            currentStage = (currentStage + 1) % totalStages;
            applyStage(stages[currentStage]);
        }

        // Initialize the first stage on load
        window.onload = () => {
            goToStage(0);
        };
    </script>
</body>
</html>